kind: secret
name: docker_user
---
kind: secret
name: docker_password
---
kind: secret
name: cluster_url
---
kind: secret
name: cluster_token
---

kind: pipeline
type: docker
name: Build

steps:
  - name: Install node modules
    image: node:10.16.3
    commands:
      - yarn install

  - name: Build production web
    image: node:10.16.3
    commands:
      - yarn run build
    when:
        branch:
          - master
          - tdcc-demo

  - name: Publish
    image: plugins/docker
    settings:
        repo: ssl1321ois/timelog_web
        tags: ${DRONE_COMMIT_BRANCH}.${DRONE_COMMIT_SHA:0:8}
        username:
            from_secret: docker_user
        password:
            from_secret: docker_password
    when: 
        event:
            - push

trigger:
    branch:
      - master
      - tdcc-demo

---

kind: pipeline
type: docker
name: Deployment

steps:
  - name: Deploy Demo
    image: nightlord851108/kustomize
    environment:
        cluster_url:
            from_secret:
                cluster_url
        CLUSTER_TOKEN:
            from_secret:
                cluster_token
    commands:
        - cd kustomize/overlays/demo
        - kustomize edit set image ssl1321ois/timelog_web:${DRONE_COMMIT_BRANCH}.${DRONE_COMMIT_SHA:0:8}
        - kustomize build . | kubectl apply --server=$${cluster_url}  --token=$${CLUSTER_TOKEN} --insecure-skip-tls-verify=true --namespace=ois-demo -f -
    when:
        branch:
          - master
          - tdcc-demo
        event:
          - push

trigger:
    branch:
      - master
      - tdcc-demo

depends_on:
  - Build
